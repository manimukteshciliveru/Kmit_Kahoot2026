version: '3.8'

services:
  # -------------------------------------------------------------------------
  # LOAD BALANCER (Nginx with Certbot)
  # -------------------------------------------------------------------------
  nginx:
    image: nginx:latest
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    command: "/bin/sh -c 'while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g \"daemon off;\"'"
    depends_on:
      app1:
        condition: service_healthy
      app2:
        condition: service_healthy
    networks:
      - app-network

  certbot:
    image: certbot/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    networks:
      - app-network

  # -------------------------------------------------------------------------
  # APPLICATION SERVERS (Node.js)
  # -------------------------------------------------------------------------
  app1:
    build: 
      context: ./server
      dockerfile: Dockerfile
    restart: always
    environment:
      - PORT=5000
      - NODE_ENV=production
      - MONGODB_URI=${MONGODB_URI}
      - REDIS_SENTINELS=redis-sentinel-1:26379,redis-sentinel-2:26379,redis-sentinel-3:26379
      - REDIS_MASTER_NAME=mymaster
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - CLIENT_URL=${CLIENT_URL}
    depends_on:
      mongo1:
        condition: service_healthy
      redis-master:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:5000/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  app2:
    build: 
      context: ./server
      dockerfile: Dockerfile
    restart: always
    environment:
      - PORT=5000
      - NODE_ENV=production
      - MONGODB_URI=${MONGODB_URI}
      - REDIS_SENTINELS=redis-sentinel-1:26379,redis-sentinel-2:26379,redis-sentinel-3:26379
      - REDIS_MASTER_NAME=mymaster
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - CLIENT_URL=${CLIENT_URL}
    depends_on:
      mongo1:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:5000/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # -------------------------------------------------------------------------
  # DATABASE (MongoDB Replica Set with Auth)
  # -------------------------------------------------------------------------
  mongo1:
    image: mongo:6.0
    restart: always
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all", "--keyFile", "/opt/keyfile/mongo-keyfile", "--auth"]
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_INITDB_ROOT_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD}
    volumes:
      - mongo1_data:/data/db
      - ./mongo-keyfile:/opt/keyfile/mongo-keyfile:ro
    networks:
      - app-network
    # NO PORTS EXPOSED PUBLICLY
    healthcheck:
      test: echo "try { rs.status().ok } catch (e) { rs.initiate({...}) }" | mongosh -u ${MONGO_INITDB_ROOT_USERNAME} -p ${MONGO_INITDB_ROOT_PASSWORD} --authenticationDatabase admin --quiet
      interval: 10s
      timeout: 10s
      retries: 5

  mongo2:
    image: mongo:6.0
    restart: always
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all", "--keyFile", "/opt/keyfile/mongo-keyfile", "--auth"]
    volumes:
      - mongo2_data:/data/db
      - ./mongo-keyfile:/opt/keyfile/mongo-keyfile:ro
    networks:
      - app-network

  mongo3:
    image: mongo:6.0
    restart: always
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all", "--keyFile", "/opt/keyfile/mongo-keyfile", "--auth"]
    volumes:
      - mongo3_data:/data/db
      - ./mongo-keyfile:/opt/keyfile/mongo-keyfile:ro
    networks:
      - app-network

  mongo-init:
    image: mongo:6.0
    depends_on:
      - mongo1
      - mongo2
      - mongo3
    env_file: .env.example
    networks:
      - app-network
    command: >
      bash -c "echo 'Waiting for mongo nodes...' && sleep 15 && 
      mongosh --host mongo1:27017 -u $${MONGO_INITDB_ROOT_USERNAME} -p $${MONGO_INITDB_ROOT_PASSWORD} --authenticationDatabase admin --eval 'try { rs.status() } catch (err) { rs.initiate({ _id: \"rs0\", members: [{ _id: 0, host: \"mongo1:27017\" }, { _id: 1, host: \"mongo2:27017\" }, { _id: 2, host: \"mongo3:27017\" }] }) }'"

  # -------------------------------------------------------------------------
  # CACHE (Redis HA with Auth)
  # -------------------------------------------------------------------------
  redis-master:
    image: redis:7.0
    restart: always
    command: ["redis-server", "--requirepass", "${REDIS_PASSWORD}", "--masterauth", "${REDIS_PASSWORD}", "--appendonly", "yes"]
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis-slave:
    image: redis:7.0
    restart: always
    command: ["redis-server", "--slaveof", "redis-master", "6379", "--requirepass", "${REDIS_PASSWORD}", "--masterauth", "${REDIS_PASSWORD}"]
    depends_on:
      - redis-master
    networks:
      - app-network

  redis-sentinel-1: &sentinel
    image: bitnami/redis-sentinel:latest
    restart: always
    environment:
      - REDIS_MASTER_HOST=redis-master
      - REDIS_MASTER_PORT_NUMBER=6379
      - REDIS_MASTER_SET=mymaster
      - REDIS_SENTINEL_QUORUM=2
      - REDIS_MASTER_PASSWORD=${REDIS_PASSWORD}
      - REDIS_SENTINEL_DOWN_AFTER_MILLISECONDS=5000
      - REDIS_SENTINEL_FAILOVER_TIMEOUT=10000
    depends_on:
      redis-master:
        condition: service_healthy
      redis-slave:
        condition: service_started
    networks:
      - app-network

  redis-sentinel-2:
    <<: *sentinel
    networks:
      - app-network

  redis-sentinel-3:
    <<: *sentinel
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

volumes:
  mongo1_data:
  mongo2_data:
  mongo3_data:
